# Static Deploy On OpensShift
# Builds and Deploys merged PR's to persistent pods/services/routes/etc in the OpenShift Dev environment.
name: Static Deploy on OpensShift
  
on:
  # https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows
  push:
    # Edit to the branch(es) you want to build and deploy on each push.
    branches: [ master ]

jobs:
  # Print variables for logging and debugging purposes
  # checkEnv:
  #   name: Check Env variables
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Print Env Vars
  #       run: |
  #         echo Git Base Ref: ${{ github.base_ref }}
  #         echo Git Build ID: ${{ github.event.number }}
  #         echo Git Pull Request Ref: ${{ github.event.pull_request.head.sha }}
  #         echo OC CLI Version: $(oc version)
  # # Build the API
  # build:
  #   name: Build and deploy APP to Dev environment
  #   runs-on: ubuntu-latest
  #   # if: ${{ github.event.pull_request.merged == true}}
  #   # env:
  #   #   BUILD_ID: ${{ github.event.number }}
  #   #   BUILD_NAMESPACE: 332842-tools
  #   #   BRANCH: ${{ github.base_ref }}
  #   #   #KC_AUTH_URL: https://dev.oidc.gov.bc.ca/auth/
  #   env:
  #     BUILD_ID: ${{ github.event.number }}
  #     NAMESPACE: 332842-dev
  #     BUILD_NAMESPACE: 332842-dev
  #     BRANCH: master
  #     APP: performance-docker-app
  #     APP_HOST: performance-docker-app-332842-dev.apps.silver.devops.gov.bc.ca
  #   steps:
  #     # Checkout the PR branch
  #     # - name: Print env
  #     #   run: |
  #     #     echo BUILD ID: $BUILD_ID
  #     #     echo BUILD NAMESPACE: $BUILD_NAMESPACE
  #     #     echo BRANCH: $BRANCH
  #     - name: Checkout Target Branch
  #       uses: actions/checkout@v1
  #     # Log in to OpenShift.
  #     # Note: The secrets needed to log in are NOT available if the PR comes from a FORK.
  #     # PR's must originate from a branch off the original repo or else all openshift `oc` commands will fail.
  #     - name: Log in to OpenShift
  #       run: |
  #         oc login --token=${{ secrets.SA_TOKEN }} --server=https://api.silver.devops.gov.bc.ca:6443
  #     # Build the api images
  #     - name: Build and deploy the app
  #       run: | 
  #         oc project ${NAMESPACE}
  #         echo "Current namespace is ${NAMESPACE}"
  #         oc start-build bc/performance-docker-app
  #         oc logs -f bc/performance-docker-app
  #         echo "Getting deployment status..."
  #         oc rollout status deployment/performance-docker-app
  #         echo "Listing pods.."
  #         oc get pods|grep performance-docker-app
  #         export ROUTE="$(oc get route performance-docker-app -o jsonpath='{.spec.host}')"
  #         echo "performance-docker-app is exposed at $ROUTE"      


  # Deploy Test
  deployTest:
    name: Deploy to Test environment
    runs-on: ubuntu-latest
    environment: TEST
    # if: ${{ github.event.pull_request.merged == true && github.base_ref == 'test'}}
    env:
      BUILD_ID: ${{ github.event.number }}
      NAMESPACE: 332842-test
      BUILD_NAMESPACE: 332842-test
      BRANCH: master
      APP: performance-docker-app
      APP_HOST: performance-docker-app-332842-test.apps.silver.devops.gov.bc.ca
      HOST_PREFIX: test-
      # KC_AUTH_URL: https://oidc.gov.bc.ca/auth/
      # DEPLOYMENT_ENV: test
      # DEPLOYMENT_ENV_HIDDEN_FLAG: prod
      # MAP_BOX_TOKEN : ${{ secrets.MAP_BOX_TOKEN }}
      # GOOGLE_API_KEY : ${{ secrets.GOOGLE_API_KEY }}
    # needs:
    #   - build
    steps:
      - name: Print env
        run: |
          echo BUILD ID: $BUILD_ID
          echo BUILD NAMESPACE: $BUILD_NAMESPACE
          echo NAMESPACE: $NAMESPACE
          echo BRANCH: $BRANCH
          echo HOST_PREFIX: $HOST_PREFIX
      # Checkout the PR branch
      - name: Checkout Target Branch
        uses: actions/checkout@v1

      # Log in to OpenShift.
      # Note: The secrets needed to log in are NOT available if the PR comes from a FORK.
      # PR's must originate from a branch off the original repo or else all openshift `oc` commands will fail.
      - name: Log in to OpenShift
        run: |
          oc login --token=${{ secrets.SA_TOKEN }} --server=https://api.silver.devops.gov.bc.ca:6443     
      - name: Deploy APP
        working-directory: "./devops/"
        run: |
          test -n "${NAMESPACE}"
          test -n "${BUILD_NAMESPACE}"
          test -n "${BRANCH}"
          echo "Current namespace is $NAMESPACE"
          oc -n ${NAMESPACE} process -f openshift/app-template.yaml \
            -p NAME=${APP} \
            -p HOST_NAME=${APP_HOST} \
            -p BUILD_NAMESPACE=${BUILD_NAMESPACE} | oc -n ${NAMESPACE} apply -f -
          $(call rollout_and_wait,dc/${APP}) 
          oc project ${NAMESPACE}     
          echo "Listing pods.."
          oc get pods|grep ${APP}
          export ROUTE="$(oc get route ${APP} -o jsonpath='{.spec.host}')"
          echo "${APP} is exposed at 'https://'$ROUTE"      
