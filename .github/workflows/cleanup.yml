# Clean Openshift
# Deletes all resources from OpenShift to prepare for a fresh deployment
name: ðŸ§¹ï¸ Clean-up

env:
  USER: ${{ github.actor }}

on:
  workflow_call:
    inputs:
      CLEAN_PVC:
        required: true
        type: string
      APP_NAME:
        required: true
        type: string
      APP_HOST_URL:
        required: true
        type: string
      DEPLOY_NAMESPACE:
        required: true
        type: string
      DB_NAME:
        required: true
        type: string
      WEB_NAME:
        required: true
        type: string
      PHP_NAME:
        required: true
        type: string
      CRON_NAME:
        required: true
        type: string
      REDIS_NAME:
        required: true
        type: string
      DB_BACKUP_DEPLOYMENT_NAME:
        required: true
        type: string
    secrets:
      SA_TOKEN:
        required: true

jobs:
  # Clean Openshift
  # Not configured for prod deployments (to be safe)
  clean:
    name: OpenShift
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    env:
      REF: ${{ github.ref_name }}
    if: |
      always()
      && (
        github.ref_name == 'e66ac2-prod' ||
        github.ref_name  == '332842-dev' ||
        github.ref_name  == '332842-test'
      )
    steps:
      - name: Setup OpenShift CLI
        uses: ./.github/workflows/setup-oc-cli.yml

      - name: ðŸ“¤ Checkout Target Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      # Get Environment Variables from file
      - name: ðŸ“‹ Setup Environment from File
        id: dotenv
        uses: falti/dotenv-action@v1
        with:
          path: .env.example
          export-variables: true
          log-variables: true
          keys-case: upper

      # Log in to OpenShift.
      # Note: The secrets needed to log in are NOT available if the PR comes from a FORK.
      # PR's must originate from a branch off the original repo or else all openshift `oc` commands will fail.
      - name: ðŸ”‘ Log in to OpenShift ( ${{ github.ref_name }} )
        run: |
          server=https://api.silver.devops.gov.bc.ca:6443
          oc login --token=${{ secrets.SA_TOKEN }} --server=$server
          oc project ${{ inputs.DEPLOY_NAMESPACE }}

      - name: ðŸ§¹ï¸ Clean Cron
        id: clean-cron-job
        run: |
          if [[ `oc describe deployment/cron 2>&1` =~ "NotFound" ]]; then
            echo "cron NOT FOUND: Skipping..."
          else
            echo "cron FOUND: Cleaning resources..."
            oc delete deployment/cron
          fi
          if [[ `oc describe deployment/${{ inputs.CRON_NAME }} 2>&1` =~ "NotFound" ]]; then
            echo "deployment/${{ inputs.CRON_NAME }} NOT FOUND: Skipping..."
          else
            echo "deployment/${{ inputs.CRON_NAME }} FOUND: Cleaning resources..."
            oc delete deployment/${{ inputs.CRON_NAME }}
          fi
          if [[ `oc describe configmap/${{ inputs.CRON_NAME }}-config 2>&1` =~ "NotFound" ]]; then
            echo "configmap/${{ inputs.CRON_NAME }}-config NOT FOUND: Skipping..."
          else
            oc delete configmap/${{ inputs.CRON_NAME }}-config
          fi

      - name: ðŸ§¹ï¸ Clean ${{ inputs.REDIS_NAME }}-redis-cluster
        run: |
          if [[ `oc describe sts ${{ inputs.REDIS_NAME }} 2>&1` =~ "NotFound" ]]; then
            echo "${{ inputs.REDIS_NAME }} NOT FOUND: Skipping..."
          else
            echo "${{ inputs.REDIS_NAME }} FOUND: Cleaning..."
            oc delete sts/${{ inputs.REDIS_NAME }}
          fi
          if [[ `oc describe configmap ${{ inputs.REDIS_NAME }}-redis-cluster-default 2>&1` =~ "NotFound" ]]; then
            echo "${{ inputs.REDIS_NAME }}-redis-cluster-default NOT FOUND: Skipping..."
          else
            oc delete configmap ${{ inputs.REDIS_NAME }}-redis-cluster-default
          fi
          if [[ `oc describe configmap ${{ inputs.REDIS_NAME }}-redis-cluster-scripts 2>&1` =~ "NotFound" ]]; then
            echo "${{ inputs.REDIS_NAME }}-redis-cluster-scripts NOT FOUND: Skipping..."
          else
            oc delete configmap ${{ inputs.REDIS_NAME }}-redis-cluster-scripts
          fi

      - name: Clean Database PVCs
        if: inputs.CLEAN_PVC == 'YES'
        run: |
          echo "Cleaning up PVCs associated with StatefulSet '${{ inputs.DB_NAME }}'..."

          # Get the list of PVCs associated with the StatefulSet '${{ inputs.DB_NAME }}'
          PVCS=$(oc get pvc -l app=${{ inputs.DB_NAME }} -o jsonpath='{.items[*].metadata.name}')
          echo "PVCs found: $PVCS"

          # Check if the StatefulSet exists
          if [[ `oc describe sts/${{ inputs.DB_NAME }} 2>&1` =~ "NotFound" ]]; then
            echo "sts/${{ inputs.DB_NAME }} NOT FOUND: Skipping..."
          else
            # Scale down the StatefulSet to 0 replicas
            echo "Scaling down StatefulSet '${{ inputs.DB_NAME }}' to 0 replicas..."
            oc scale sts/${{ inputs.DB_NAME }} --replicas=0

            # Wait for the StatefulSet to scale down
            echo "Waiting for StatefulSet '${{ inputs.DB_NAME }}' to scale down..."
            while [[ $(oc get pods -l app=${{ inputs.DB_NAME }} -o jsonpath='{.items[*].status.phase}' | grep -v "Terminating") ]]; do
              echo "Waiting for pods to terminate..."
              sleep 5
            done

            # Loop through each PVC and delete it
            for PVC in $PVCS; do
              echo "Deleting PVC: $PVC"
              oc delete pvc $PVC
            done
          fi

          echo "PVC cleanup completed."

      - name: ðŸ§¹ï¸ Clean ${{ inputs.DB_NAME }}
        run: |
          configmap_name="${{ inputs.DB_NAME }}"
          if [[ `oc describe sts/${{ inputs.DB_NAME }} 2>&1` =~ "NotFound" ]]; then
            echo "sts/${{ inputs.DB_NAME }} NOT FOUND: Skipping..."
          else
            echo "sts/${{ inputs.DB_NAME }} FOUND: Cleaning..."
            oc scale sts/${{ inputs.DB_NAME }} --replicas=0

            # Wait for the StatefulSet to scale down
            echo "Waiting for StatefulSet '${{ inputs.DB_NAME }}' to scale down..."
            while [[ $(oc get pods -l app=${{ inputs.DB_NAME }} -o jsonpath='{.items[*].status.phase}' | grep -v "Terminating") ]]; do
              echo "Waiting for pods to terminate..."
              sleep 5
            done

            oc delete sts/${{ inputs.DB_NAME }}
          fi
          if ! [[ `oc describe configmap/$configmap_name 2>&1` =~ "NotFound" ]]; then
            oc delete configmap/$configmap_name
          fi
          if ! [[ `oc describe service/${{ inputs.DB_NAME }} 2>&1` =~ "NotFound" ]]; then
            oc delete service ${{ inputs.DB_NAME }}
          fi

          echo "${{ inputs.DB_NAME }} cleanup completed."

      - name: ðŸ§¹ï¸ Clean ${{ inputs.WEB_NAME }}
        id: clean-web
        run: |
          configmap_name="${{ inputs.WEB_NAME }}-config"
          if [[ `oc describe deployment/${{ inputs.WEB_NAME }} 2>&1` =~ "NotFound" ]]; then
            echo "${{ inputs.WEB_NAME }} NOT FOUND: Skipping..."
          else
            echo "${{ inputs.WEB_NAME }} FOUND: Cleaning resources..."
            oc scale deployment/${{ inputs.WEB_NAME }} --replicas=0
            sleep 10
            oc delete deployment/${{ inputs.WEB_NAME }}
          fi
          if [[ `oc describe configmap $configmap_name 2>&1` =~ "NotFound" ]]; then
            echo "$configmap_name NOT FOUND: Skipping..."
          else
            oc delete configmap $configmap_name
          fi
          if [[ `oc describe configmap ${{ inputs.APP_NAME }}-env 2>&1` =~ "NotFound" ]]; then
            echo "Configmap ${{ inputs.APP_NAME }}-env NOT FOUND: Skipping..."
          else
            oc delete configmap ${{ inputs.APP_NAME }}-env
          fi
          if ! [[ `oc describe service ${{ inputs.WEB_NAME }} 2>&1` =~ "NotFound" ]]; then
            oc delete service ${{ inputs.WEB_NAME }}
          fi

          echo "${{ inputs.WEB_NAME }} cleanup completed."

      - name: ðŸ§¹ï¸ Clean Migrate-Build Job
        id: clean-migrate-build
        run: |
          if [[ `oc describe job migrate-build-files 2>&1` =~ "NotFound" ]]; then
            echo "migrate-build-files NOT FOUND: Skipping..."
          else
            echo "migrate-build-files FOUND: Cleaning resources..."
            oc delete job migrate-build-files
          fi

      - name: ðŸ§¹ï¸ Clean ${{ inputs.PHP_NAME }}
        id: clean-php
        run: |
          configmap_name="${{ inputs.APP_NAME }}-env"
          if [[ `oc describe deployment/${{ inputs.PHP_NAME }} 2>&1` =~ "NotFound" ]]; then
            echo "${{ inputs.PHP_NAME }} NOT FOUND: Skipping..."
          else
            echo "${{ inputs.PHP_NAME }} FOUND: Cleaning resources..."
            oc scale deployment/${{ inputs.PHP_NAME }} --replicas=0
            sleep 10
            oc delete deployment/${{ inputs.PHP_NAME }}
          fi
          if [[ `oc describe configmap/$configmap_name 2>&1` =~ "NotFound" ]]; then
            echo "configmap/$configmap_name NOT FOUND: Skipping..."
          else
            oc delete configmap/$configmap_name
          fi
          if ! [[ `oc describe service/${{ inputs.PHP_NAME }} 2>&1` =~ "NotFound" ]]; then
            oc delete service/${{ inputs.PHP_NAME }}
          fi
          if ! [[ `oc describe pvc/${{ inputs.APP_NAME }}-data 2>&1` =~ "NotFound" ]]; then
            oc delete pvc/${{ inputs.APP_NAME }}-data
          fi
          if ! [[ `oc describe pvc/${{ inputs.APP_NAME }}-app-data 2>&1` =~ "NotFound" ]]; then
            oc delete pvc/${{ inputs.APP_NAME }}-app-data
          fi

          echo "${{ inputs.PHP_NAME }} cleanup completed."

      - name: ðŸ§¹ï¸ Clean Redis
        id: clean-redis
        run: |
          redis_config_map="${{ inputs.REDIS_NAME }}-config-map"
          redis_stats_config_map="${{ inputs.REDIS_NAME }}-stats"
          if [[ `oc describe sts/${{ inputs.REDIS_NAME }} 2>&1` =~ "NotFound" ]]; then
            echo "sts/${{ inputs.REDIS_NAME }} NOT FOUND: Skipping..."
          else
            echo "sts/${{ inputs.REDIS_NAME }} FOUND: Cleaning resources..."
            oc delete sts/${{ inputs.REDIS_NAME }}
          fi
          if [[ `oc describe configmap/$redis_config_map 2>&1` =~ "NotFound" ]]; then
            echo "configmap/$redis_config_map NOT FOUND: Skipping..."
          else
            oc delete configmap/$redis_config_map
          fi
          if [[ `oc describe configmap/$redis_stats_config_map 2>&1` =~ "NotFound" ]]; then
            echo "configmap/$redis_stats_config_map NOT FOUND: Skipping..."
          else
            oc delete configmap/$redis_stats_config_map
          fi

      - name: ðŸ§¹ï¸ Clean Upgrade Job
        id: clean-upgrade-job
        run: |
          if [[ `oc describe job/${{ inputs.APP_NAME }}-upgrade 2>&1` =~ "NotFound" ]]; then
            echo "job/${{ inputs.APP_NAME }}-upgrade NOT FOUND: Skipping..."
          else
            echo "job/${{ inputs.APP_NAME }}-upgrade FOUND: Cleaning resources..."
            oc delete job/${{ inputs.APP_NAME }}-upgrade
            echo "DELETED job/${{ inputs.APP_NAME }}-upgrade"
          fi

      - name: ðŸ§¹ï¸ Clean ${{ inputs.APP_NAME}}-${{ inputs.WEB_NAME }} | ${{ inputs.APP_HOST_URL }}
        id: clean-route
        run: |
          route_name="${{ inputs.APP_NAME}}-${{ inputs.WEB_NAME }}"
          if [[ `oc describe route/$route_name 2>&1` =~ "NotFound" ]]; then
            echo "Route NOT FOUND: $route_name - Skipping..."
          else
            echo "route/$route_name FOUND: Cleaning resources..."
            oc delete route/$route_name
          fi

      - name: ðŸ§¹ï¸ Clean ${{ inputs.APP_NAME}}-secrets
        id: clean-secrets
        run: |
          if [[ `oc describe secret/${{ inputs.APP_NAME}}-secrets 2>&1` =~ "NotFound" ]]; then
            echo "secret/${{ inputs.APP_NAME}} NOT FOUND: Skipping..."
          else
            echo "secret/${{ inputs.APP_NAME}} FOUND: Cleaning resources..."
            oc delete secret/${{ inputs.APP_NAME}}-secrets
          fi

      - name: ðŸ§¹ï¸ Clean Backups
        id: clean-backups
        run: |
          echo "Checking Helm release status for '${{ inputs.DB_BACKUP_DEPLOYMENT_NAME }}'..."

          if [ "${{ inputs.CLEAN_PVC }}" = "YES"  ]; then
            # Temporarily disable exit on error
            set +e

            # Capture the output and exit code of the helm status command
            HELM_STATUS_OUTPUT=$(helm status ${{ inputs.DB_BACKUP_DEPLOYMENT_NAME }} 2>&1)
            HELM_STATUS_EXIT_CODE=$?

            # Re-enable exit on error
            set -e

            echo "Helm status output: $HELM_STATUS_OUTPUT"
            echo "Helm status exit code: $HELM_STATUS_EXIT_CODE"

            # Check if the Helm release is deployed or not found
            if [ $HELM_STATUS_EXIT_CODE -eq 0 ]; then
              # echo "Helm release '${{ inputs.DB_BACKUP_DEPLOYMENT_NAME }}' is deployed. Proceeding with uninstallation..."
              # helm uninstall ${{ inputs.DB_BACKUP_DEPLOYMENT_NAME }}
              echo "Helm release '${{ inputs.DB_BACKUP_DEPLOYMENT_NAME }}' is deployed. Let's leave it in place to avoid any catastrophes..."
            elif echo "$HELM_STATUS_OUTPUT" | grep -qi "release: not found"; then
              echo "Helm release '${{ inputs.DB_BACKUP_DEPLOYMENT_NAME }}' not found. Skipping uninstallation..."
            else
              echo "Unexpected error checking Helm release status: $HELM_STATUS_OUTPUT"
              exit 1
            fi
          else
            echo "Cleaning backups skipped due to PVC cleanup being disabled."
          fi
