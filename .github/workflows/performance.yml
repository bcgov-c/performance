name: Performance

concurrency:
  group: performance-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: performance
  USER: ${{ github.actor }}
  DEPLOY_NAMESPACE: ${{ github.ref_name }}

on:
  workflow_call:
jobs:
  build-images:
    name: 'üê∏ Build to JFrog'
    runs-on: ubuntu-latest
    if: (github.ref_name == 'e66ac2-prod' || github.ref_name == 'dev' || github.ref_name == 'test' || github.ref_name == 'prod')
    steps:
      # Checkout the PR branch
      - name: üì§ Checkout Target Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      # Login to Artifactory
      - name: üîë Login to Artifactory
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ARTIFACTORY_URL }}
          username: ${{ secrets.ARTIFACTORY_USER }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      - name: Setup Env Vars
        id: dotenv
        uses: falti/dotenv-action@v1
        with:
          path: .env.example
          export-variables: true
          keys-case: upper

      - name: Setup Env Version Vars
        id: dotenv_versions
        uses: falti/dotenv-action@v1
        with:
          path: .env.example.versions
          export-variables: true
          keys-case: upper

      - name: üê∏ Buld to JFrog
        run: docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --build-arg APP_KEY_ARG=${{ secrets.APP_KEY }} --build-arg DOCKER_FROM_IMAGE=${{ secrets.ARTIFACTORY_URL }}/${{ env.PHP_IMAGE }} --tag ${{ secrets.ARTIFACTORY_URL }}/${{ env.APP_NAME }}:${{ env.DEPLOY_NAMESPACE }} --output=type=image,push=true --push -f ${{ env.DOCKER_FILE_PATH }} .

